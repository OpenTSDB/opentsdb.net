<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Development - OpenTSDB - A Distributed, Scalable Monitoring System</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen"/>
<!--[if lte IE 8]>
<link rel="stylesheet" href="css/ie.css" type="text/css" media="screen"/>
<![endif]-->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18339382-1']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
<header><div id="headerbar">
  <h1><a href="index.html">OpenTSDB</a></h1>
  <nav><ul id="navbar">
    <li><a href="overview.html">Overview</a></li>
    <li><a href="getting-started.html">Getting Started</a></li>
    <li><a href="manual.html">Manual</a></li>
    <li><a href="faq.html">FAQ</a></li>
  </ul></nav>
</div></header>

<!--[if lte IE 8]>
<div class="iesucks">Warning: You're using an unsupported, archaic browser.
Get a better, modern browsing experience with
<a href="http://www.google.com/chrome">Chrome</a> or
<a href="http://www.mozilla.com/firefox">Firefox</a>.</div>
<![endif]-->
<section id="content">
<section id="Development">
<h2>Development</h2>
OpenTSDB isn't laid out like a typical Java project, instead simulating a C or C++ environment. This page is to help folks who want to modify OpenTSDB and provide updates back to the community.

<h2>Build System</h2>
<p>There are almost as many build systems as there are developers so it's impossible to satisfy everyone no matter which system or layout is chosen. Autotools and Make were chosen early on for OpenTSDB because of it's flexibility, portability, speed and popular usage. It's not the easiest to configure but for our needs, it's really not too difficult. We'll spell out what you need to change below and give tips for IDE users who want to setup an environment. 
  
  Note that the build script can now compile a "pom.xml" file for compiling with Maven. However you still have to modify Makefile.am if you add/remove classes and such.
 </p>
<h3>Building</h3>
<p>Each build will create a ./build directory in the project folder. When testing modifications, be sure to delete this ./build folder so you can start fresh and verify that all of the dependencies download properly.</p>
<h3>Adding a Dependency</h3>

First off, don't. Really, please try your best not to. But if you absolutely must, here are the steps:

<ul>
<li>Find the canonical source to download the dependencies JAR file</li>
<li>Find or create the proper directory under ./third_party</li>
<li>In that directory, create a "depdencency.jar".md5 file</li>
<li>Paste the MD5 hash of the entire jar in that file and save it</li>
<li>Create or edit the include.mk file and copy the header info from another directory's file
  <ul>
    <li>Add a &quot;&lt;DEPENDENCY&gt;_VERSION := &lt;version&gt;&quot; e.g. &quot;JACKSON_VERSION := 1.9.4&quot;</li>
    <li>Add a &quot;&lt;DEPENDENCY&gt; := third_parth/&lt;DIR&gt;/&lt;dependency&gt;$(&lt;DEPENDENCY&gt;_VERSION).jar&quot; line e.g. &quot;JACKSON_CORE := third_party/jackson/jackson-core-lgpl-$(JACKSON_CORE_VERSION).jar&quot;</li>
    <li>Add the canonical source URL in the format &quot;&lt;DEPENDENCY&gt;_BASE_URL := &lt;URL&gt;&quot; e.g. &quot;JACKSON_CORE_BASE_URL := http://repository.codehaus.org/org/codehaus/jackson/jackson-core-lgpl/$(JACKSON_VERSION)&quot; and note that the JAR name will be appended to the end of the URL</li>
    <li>Add the following lines:<br />
      $(&lt;DEPENDENCY&gt;): $(J&lt;DEPENDENCY&gt;).md5<br />
      set dummy &quot;$(&lt;DEPENDENCY&gt;_BASE_URL)&quot; &quot;$(&lt;DEPENDENCY&gt;)&quot;; shift; $(FETCH_DEPENDENCY)<br /> 
      e.g.<br />
      $(JACKSON_CORE): $(JACKSON_CORE).md5<br />
      set dummy &quot;$(JACKSON_CORE_BASE_URL)&quot; &quot;$(JACKSON_CORE)&quot;; shift; $(FETCH_DEPENDENCY)</li>
    <li>Add a line &quot;THIRD_PARTY += $(&lt;DEPENDENCY&gt;)&quot; e.g. &quot;THIRD_PARTY += $(JACKSON_CORE) &quot;</li>
    </ul>
</li>
<li>Next, back in the ./third_party directory, edit the &quot;include.mk&quot; file and if you added a new directory for your dependency, insert a reference to the .mk file in the proper alphabetical position.</li>
<li>Edit ./Makefile.aml
  <ul>
    <li>Find the &quot;tsdb_DEPS = \&quot; line</li>
    <li>Add your new dependency in the proper alphabetical position in the format &quot;$(&lt;DEPENDENCY&gt;)&quot;, e.g. &quot;$(JACKSON_CORE&gt;&quot;. Note that if you put it the middle of the list, you must finish with the line continuation character, the backslash &quot;\&quot;. If your dependency goes at the end, do not add the backslash.</li>
    <li>Note: If the dependency is only used for unit tests, then add it to the &quot;test_DEPS = \&quot; list</li>
    <li>Find the &quot;pom.xml: pom.xml.in Makefile&quot; line in the file</li>
    <li>Add a sed line such as &quot;-e 's/@&lt;DEPENDENCY&gt;_VERSION@/$(&lt;DEPENDENCY&gt;_VERSION)/' \&quot; e.g. &quot;-e 's/@JACKSON_VERSION@/$(JACKSON_VERSION)/' \&quot;</li>
    <li>Note: Unit test dependencies go here as well as regular items</li>
    </ul>
</li>
<li>Edit ./pom.xml.in
  <ul>
    <li>Find the &quot;&lt;dependencies&gt;&quot; XML section</li>
    <li>Copy and paste an existing dependency section and modify it for your variables</li>
    </ul>
</li>
</ul>
<p>Now run a build via &quot;sh build.sh&quot; and verify that it fetches your dependency and builds without errors. Then run &quot;sh build.sh pom.xml&quot; to verify that the POM is compiled properly and run a &quot;mvn compile&quot; to verif the Maven build works correctly. </p>
<h3>Adding/Removing/Moving a Class</h3>
<p>This is much easier than dealing with a dependency. You only need to modify the ./Makefile.am and edit the &quot;tsdb_SRC := \&quot;  or the &quot;test_SRC := \&quot; lists. If you're adding a class, put it in the proper alphabetical position and account for the proper directory and class name. It is case sensitive so make sure to get that right. If removing a class, just delete the line. If moving a class, add the new line and delete the old one. Be careful to handle the line continuation &quot;\&quot; backslashes. The last class in each list should NOT end with a backslash, the rest need it.</p>
<p>After editing, rebuild with &quot;sh build.sh&quot; and verify that your class was compiled and included properly.</p>
<h2>IDEs</h2>
<p>Many devs use an IDE to work on JAVA projects and despite OpenTSDBs non-java-standard directory layout, working with an IDE is pretty easy. Here are some steps to get up and running with Eclipse though they should work with other environments.</p>
<ol>
  <li>Cone the GIT repo to a location such as &quot;/home/hobbes/opentsdb&quot;</li>
  <li>Build the repo with &quot;sh build.sh&quot; from the directory</li>
  <li>Fire up Eclipse or your favoriate IDE</li>
  <li>Create a new JAVA project with a name like &quot;opentsdb_dev&quot; so that it winds up in &quot;/home/hobbes/opentsdb_dev&quot;</li>
  <li>Your dev directory should now have a &quot;./src&quot; directory</li>
  <li>Create a &quot;net&quot; directory under &quot;./src&quot; so that you have &quot;./src/net&quot; (some IDEs may create a &quot;./src/java&quot; dir, so add &quot;./src/java/net&quot;)</li>
  <li>Create a symlink to the GIT repo's &quot;./src&quot; directory from &quot;./src/net/opentsdb&quot;. E.g. &quot;ln -s /home/hobbes/opentsdb/src /home/hobbes/opentsdb_dev/src/net/opentdsb&quot;</li>
  <li>Also, create a &quot;tsd&quot; directory under &quot;./src&quot; so that you have &quot;./src/tsd&quot;</li>
  <li>Create a symlink to the GIT repo's &quot;./src/tsd/client&quot; directory from &quot;./src/tsd/client&quot;. E.g. &quot;ln -s /home/hobbes/opentsdb/src/tsd/client /home/hobbes/opentsdb_dev/src/tsd/client&quot;<br />
  </li>
  <li>If your IDE didn't, create a &quot;./test&quot; directory under your dev project folder. This will be used for unit tests.</li>
  <li>Add a &quot;net&quot; directory under &quot;./test&quot; so you have &quot;./test/net&quot;</li>
  <li>Create a symlink to the GIT repo's &quot;./test&quot; directory from &quot;./test/net/opentsdb&quot;. E.g. &quot;ln -s /home/hobbes/opentsdb/test /home/hobbes/opentsdb_dev/test/net/opentdsb&quot;</li>
  <li>Refresh the directory lists in Eclipse and you should see all of the source files</li>
  <li>Right click the &quot;net.opentsdb.tsd.client&quot; package under SRC and select &quot;Build Path&quot; then &quot;Exclude&quot; from the menu</li>
  <li>Now add the downloaded dependencies by clicking Project -&gt; Properties, click the &quot;Java Build Path&quot; menu item and click &quot;Add External JARs&quot; button. </li>
  <li>Do that for each of the dependencies that were downloaded by the build script</li>
  <li>Copy the file &quot;./build/src/BuildData.java&quot; from the GIT repo, post build, to your &quot;./src/net/opentsdb/&quot; directory</li>
  <li>Now click Run (or Debug) -&gt; Manage Configurations</li>
  <li>Under Java Application, right click and select New from the pop-up</li>
  <li>Under the Main tab, brows to your &quot;opentsdb_dev&quot; project</li>
  <li>For the Main Class, search for &quot;net.opentsdb.tools.TSDMain&quot;</li>
  <li>Under Arguments, add the runtime arguments to select your Zookeeper quorum and the static and cache directories</li>
  <li>Run or Debug it and hopefully it worked</li>
</ol>
<p>Now edit away and when you're ready to publish changes, follow the directions above about modifying the Build systme (if necessary), publish to your own Github fork, and issue a pull request.</p>
<p>NOTE: This won't compile the GWT UI. If you want to do UI work and have made changes, recompile OpenTSDB or export it as a JAR from your IDE, then execute the following command (assuming the directory structure above):</p>
<p>java -cp  &quot;&lt;PATH_TO&gt;gwt-dev-2.4.0.jar;&lt;PATH_TO&gt;gwt-user-2.4.0.jar;&lt;PATH_TO&gt;tsdb-1.1.0.jar;/home/hobbes/opentsdb/src/net/opentsdb;/home/hobbes/opentsdb/src&quot;  com.google.gwt.dev.Compiler -ea -war &lt;PATH_TO_STATIC_DIRECTORY&gt; tsd.Queryui</p>
</section><footer>
&copy; 2010&ndash;2013 The OpenTSDB Authors.
</footer>
</section></body></html>
