<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bucket Quantile &#8212; OpenTSDB 3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Downsample" href="downsample.html" />
    <link rel="prev" title="Semantic Query (Version 3)" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          OpenTSDB</a>
        <span class="navbar-text navbar-version pull-left"><b>3.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/OpenTSDB/opentsdb/releases">Download</a></li>
                <li><a href="https://github.com/OpenTSDB/opentsdb">Source</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes in 3.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changes.html#new-features">New Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changes.html#whats-missing">Whats Missing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation and Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#runtime-requirements">Runtime Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#compile">Compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#local">Local</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#id1">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#querying">Querying</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Users Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Semantic Query (Version 3)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../admin_guide/index.html">Administrators Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../admin_guide/configuration.html">TSDB Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../admin_guide/logging.html">Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api_http/index.html">HTTP API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#version-2-x-to-3-x">Version 2.X to 3.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#authentication-permissions">Authentication/Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#response-codes">Response Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#verbs">Verbs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#query-string-vs-body-content">Query String Vs. Body Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#compressed-requests">Compressed Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#cors">CORS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#deprecated-api">Deprecated API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api_http/index.html#api-endpoints">API Endpoints</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="index.html" title="Previous Chapter: Semantic Query (Version 3)"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Semantic Quer...</span>
    </a>
  </li>
  <li>
    <a href="downsample.html" title="Next Chapter: Downsample"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Downsample &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Bucket Quantile</a><ul>
<li><a class="reference internal" href="#parsing-buckets">Parsing Buckets</a></li>
<li><a class="reference internal" href="#cumulative-and-counter-buckets">Cumulative and Counter Buckets</a></li>
<li><a class="reference internal" href="#query-example">Query Example</a></li>
<li><a class="reference internal" href="#output">Output</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="bucket-quantile">
<h1>Bucket Quantile</h1>
<p>Aggregating quantiles (or percentiles) across multiple sources gives an imprecise and inaccurate estimation of the actual value. To solve this, a number of metric storage systems support bucketed histograms where the source slices up a measurement range into upper and lower boundaries then sends the count of measurements that fall within each bucket. The query layer can then sum the counts across multiple sources and accurately compute a quantile. For more information about histograms see _TODO_.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The node currently only supports buckets in the metric name. We’ll support buckets as tag values in the future.</p>
</div>
<p>Fields include:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 55%" />
<col style="width: 10%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bucketRegex</p></td>
<td><p>String</p></td>
<td><p>Required</p></td>
<td><p>A regular expression used to extract bucket boundaries from metric names.</p></td>
<td><p>.*?[.-_](-?[0-9.]+[eE]?-?[0-9]*)[_-](-?[0-9.]+[eE]?-?[0-9]*)$</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>histograms</p></td>
<td><p>List</p></td>
<td><p>Required</p></td>
<td><p>A list of one or more metric IDs from TimeSeriesDataSourceConfig nodes that represent bounded histogram bucket metrics. The order does not matter but all buckets must be included in order for the calculation to complete.</p></td>
<td><p>null</p></td>
<td><p>[“m1”: “m2”]</p></td>
</tr>
<tr class="row-even"><td><p>quantiles</p></td>
<td><p>List</p></td>
<td><p>Required</p></td>
<td><p>A list of one or more quantiles (<code class="docutils literal notranslate"><span class="pre">0.999</span></code>) or percentiles (<code class="docutils literal notranslate"><span class="pre">99.9</span></code>) as floating point numbers. The order does not matter. At this time, quantiles are converted to percentiles (i.e. if the value is &lt; 1 we multiply it by 100).</p></td>
<td><p>null</p></td>
<td><p>[99.0, 99.9, 99.99]</p></td>
</tr>
<tr class="row-odd"><td><p>as</p></td>
<td><p>String</p></td>
<td><p>Required</p></td>
<td><p>A string used to label the metrics that are output from the node. Tags are preseved</p></td>
<td><p>null</p></td>
<td><p>latency.percentile</p></td>
</tr>
<tr class="row-even"><td><p>overflow</p></td>
<td><p>String</p></td>
<td><p>Optional</p></td>
<td><p>The metric ID for a TimeSeriesDataSourceConfig node that measures the overflow bucket, i.e. measurements beyond the bucketed histogram bounds.</p></td>
<td><p>null</p></td>
<td><p>m_4</p></td>
</tr>
<tr class="row-odd"><td><p>underflow</p></td>
<td><p>String</p></td>
<td><p>Optional</p></td>
<td><p>The metric ID for a TimeSeriesDataSourceConfig node that measures the under bucket, i.e. measurements less than the bucketed histogram bounds.</p></td>
<td><p>null</p></td>
<td><p>m_3</p></td>
</tr>
<tr class="row-even"><td><p>overflowMax</p></td>
<td><p>Float</p></td>
<td><p>Optional</p></td>
<td><p>When an overflow bucket is present and it’s count satisfies the quantile, this value can be used to substitute for the reporting value instead of the maximum Double value in Java.</p></td>
<td><p>Java’s Double.MAX_VALUE</p></td>
<td><p>1024.5</p></td>
</tr>
<tr class="row-odd"><td><p>underflowMin</p></td>
<td><p>Float</p></td>
<td><p>Optional</p></td>
<td><p>When an underflow bucket is present and it’s count satisfies the quantile, this value can be used to substitute for the reporting value instead of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>outputOfBucket</p></td>
<td><p>String</p></td>
<td><p>Optional</p></td>
<td><p>Determines the value to report for a given bucket when the quantile calculation selects it for reporting. Possible values are <code class="docutils literal notranslate"><span class="pre">MEAN</span></code> to report the average of the bucket upper and lower boundaries, <code class="docutils literal notranslate"><span class="pre">TOP</span></code> to report the upper boundary, or <code class="docutils literal notranslate"><span class="pre">BOTTOM</span></code> to report the lower boundary.</p></td>
<td><p>MEAN</p></td>
<td><p>TOP</p></td>
</tr>
<tr class="row-odd"><td><p>cumulativeBuckets</p></td>
<td><p>boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not this histogram contains cumulative bucket counts or separated bucket counts. See <span class="xref std std-ref">Cumulative and Counter Bucket</span>.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>counterBuckets</p></td>
<td><p>boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not the counts in the buckets are monotonically increasing counters. See <span class="xref std std-ref">Cumulative and Counter Bucket</span>.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>nanThreshold</p></td>
<td><p>Float</p></td>
<td><p>Optional</p></td>
<td><p>If the number of missing counts across histogram buckets at a given timestamp is greater than the given percentage, the output will be a NaN instead of a calculated quantile. This can be used to avoid giving errant results. When set to 0, the threshold is ignored and missing values are skipped during calculation.</p></td>
<td><p>0</p></td>
<td><p>25.5</p></td>
</tr>
<tr class="row-even"><td><p>missingMetricThreshold</p></td>
<td><p>Float</p></td>
<td><p>Optional</p></td>
<td><p>If the number of missing histogram time series for the query range is greater than the given threshold, the node will skip calculating quantiles and return an empty result. This can be used to avoid giving errant results. If set to 0, quantiles are computed despite the missing buckets.</p></td>
<td><p>0</p></td>
<td><p>15.5</p></td>
</tr>
</tbody>
</table>
<div class="section" id="parsing-buckets">
<h2>Parsing Buckets</h2>
<p>Currently the node only supports bucket boundaries in the metric name. The default regular expression to capture the buckets expects the boundaries to be at the end of the metric string separated by an under score <code class="docutils literal notranslate"><span class="pre">_</span></code> or hyphen <code class="docutils literal notranslate"><span class="pre">-</span></code>. E.g. <code class="docutils literal notranslate"><span class="pre">tsdb.query.user.latency.250.50_500.50</span></code> would parse the lower bucket boundary as <code class="docutils literal notranslate"><span class="pre">250.5</span></code> and the upper bucket boundary as <code class="docutils literal notranslate"><span class="pre">500.5</span></code>. All metrics for the histogram must share the same format to satisfy the same regex (with the exception of the underflow and overflow buckets that are provided in the configuration separately).</p>
</div>
<div class="section" id="cumulative-and-counter-buckets">
<h2>Cumulative and Counter Buckets</h2>
<p>Some systems report histogram counts as the number of measurements that fell within that bucket at that time, e.g.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 75%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Bucket Boundaries</p></th>
<th class="head"><p>Count</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0-100</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>100-200</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>200-300</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>300-400</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="query-example">
<h2>Query Example</h2>
<p>The following is an example query node configuration that uses the default thresholds and computes three quantiles across 13 histogram metrics and an overflow and underflow bucket.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;ptile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;BucketQuantile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="s2">&quot;tsdb.query.user.latency.percentile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantiles&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mf">75</span><span class="p">,</span> <span class="mf">90</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">],</span>
    <span class="s2">&quot;histograms&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;q1_m1&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m2&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m3&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m4&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m5&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m6&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m7&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m8&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m9&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m10&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m11&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m12&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m13&quot;</span><span class="p">],</span>
    <span class="s2">&quot;overflow&quot;</span><span class="o">:</span> <span class="s2">&quot;q1_m14&quot;</span><span class="p">,</span>
    <span class="s2">&quot;underflow&quot;</span><span class="o">:</span> <span class="s2">&quot;q1_m15&quot;</span><span class="p">,</span>
    <span class="s2">&quot;interpolatorConfigs&quot;</span><span class="o">:</span> <span class="p">[{</span>
       <span class="s2">&quot;dataType&quot;</span><span class="o">:</span> <span class="s2">&quot;numeric&quot;</span><span class="p">,</span>
       <span class="s2">&quot;fillPolicy&quot;</span><span class="o">:</span> <span class="s2">&quot;NAN&quot;</span><span class="p">,</span>
       <span class="s2">&quot;realFillPolicy&quot;</span><span class="o">:</span> <span class="s2">&quot;NONE&quot;</span>
    <span class="p">}],</span>
    <span class="s2">&quot;sources&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;q1_m1_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m2_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m3_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m4_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m5_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m6_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m7_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m8_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m9_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m10_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m11_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m12_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m13_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m14_groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;q1_m15_groupby&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="output">
<h2>Output</h2>
<p>The output of the node will be a set of metrics with the <code class="docutils literal notranslate"><span class="pre">as</span></code> string substituted the metric name and the quantile appended to the existing tag set with the key as <code class="docutils literal notranslate"><span class="pre">_quantile</span></code> and the value as the given quantile to be calculated with the decimals rounded to 3 places, e.g.:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;metric&quot;</span><span class="o">:</span> <span class="s2">&quot;tsdb.query.user.latency.percentile&quot;</span><span class="p">,</span>
<span class="s2">&quot;tags&quot;</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">&quot;colo&quot;</span><span class="o">:</span> <span class="s2">&quot;gq1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_quantile&quot;</span><span class="o">:</span> <span class="s2">&quot;75.000&quot;</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020, OpenTSDB.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>