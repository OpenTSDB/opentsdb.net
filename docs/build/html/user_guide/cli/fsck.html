<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fsck &mdash; OpenTDSB 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="OpenTDSB 2.0 documentation" href="../../index.html" />
    <link rel="up" title="CLI Tools" href="index.html" />
    <link rel="next" title="scan" href="scan.html" />
    <link rel="prev" title="query" href="query.html" /><link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'>
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18339382-1']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="scan.html" title="scan"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="query.html" title="query"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">OpenTDSB 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >User Guide</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">CLI Tools</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">fsck</a><ul>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
<li><a class="reference internal" href="#full-table-vs-queries">Full Table Vs Queries</a></li>
<li><a class="reference internal" href="#results">Results</a></li>
<li><a class="reference internal" href="#types-of-errors-and-fixes">Types of Errors and Fixes</a><ul>
<li><a class="reference internal" href="#bad-row-keys">Bad Row Keys</a></li>
<li><a class="reference internal" href="#orphaned-rows">Orphaned Rows</a></li>
<li><a class="reference internal" href="#compact-row">Compact Row</a></li>
<li><a class="reference internal" href="#bad-compacted-column-error">Bad Compacted Column Error</a></li>
<li><a class="reference internal" href="#compacted-last-byte-error">Compacted Last Byte Error</a></li>
<li><a class="reference internal" href="#value-too-long-or-short">Value Too Long Or Short</a></li>
<li><a class="reference internal" href="#old-version-floats">Old Version Floats</a></li>
<li><a class="reference internal" href="#byte-floats-with-8-byte-value-ok">4 Byte Floats with 8 Byte Value OK</a></li>
<li><a class="reference internal" href="#byte-floats-with-8-byte-value-bad">4 Byte Floats with 8 Byte Value Bad</a></li>
<li><a class="reference internal" href="#unknown-object">Unknown Object</a></li>
<li><a class="reference internal" href="#future-object">Future Object</a></li>
<li><a class="reference internal" href="#duplicate-timestamps">Duplicate Timestamps</a></li>
<li><a class="reference internal" href="#variable-length-encoding">Variable-Length Encoding</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="query.html"
                        title="previous chapter">query</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="scan.html"
                        title="next chapter">scan</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="fsck">
<h1>fsck</h1>
<p>Similar to a file system check, the fsck command will scan and, optionally, attempt to repair problems with data points in OpenTSDB's data table. The fsck command only operates on the <tt class="docutils literal"><span class="pre">tsdb</span></tt> storage table, scanning the entire data table or any rows of data that match on a given query. Fsck can be used to repair errors and also reclaim space by compacting rows that were not compacted by a TSD and variable-length encoding data points from previous versions of OpenTSDB.</p>
<p>By default, running fsck will only report errors found by the query. No changes are made to the underlying data unless you supply the <tt class="docutils literal"><span class="pre">--fix</span></tt> or <tt class="docutils literal"><span class="pre">--fix-all</span></tt> flags. Generally you should run an fsck without a fix flag first and verify issues found in the log file. If you're confident in the repairs, add a fix flag. Not all errors can be repaired automatically.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Running fsck with <tt class="docutils literal"><span class="pre">--fix</span></tt> or <tt class="docutils literal"><span class="pre">--fix-all</span></tt> may delete data points, columns or entire rows and deleted data is unrecoverable unless you restore from a backup. (or perform some HBase trickery to restore the data before a major compaction)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This page documents the OpenTSDB 2.1 fsck utility. For previous versions, only the <tt class="docutils literal"><span class="pre">--fix</span></tt> flag is available and only data within a query may be fsckd.</p>
</div>
<div class="section" id="parameters">
<h2>Parameters</h2>
<div class="highlight-bash"><div class="highlight"><pre>fsck <span class="o">[</span>flags<span class="o">]</span> <span class="o">[</span>START-DATE <span class="o">[</span>END-DATE<span class="o">]</span> query <span class="o">[</span>queries...<span class="o">]]</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="5%" />
<col width="40%" />
<col width="5%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Data Type</th>
<th class="head">Description</th>
<th class="head">Default</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>--fix</td>
<td>Flag</td>
<td>Optional flag that will attempt to repair errors. By itself, fix will only repair sign extension bugs, 8 byte floats with 4 byte qualifiers and VLE stand-alone data points. Use in conjunction with other flags to repair more issues.</td>
<td>Not set</td>
<td>--fix</td>
</tr>
<tr class="row-odd"><td>--fix-all</td>
<td>Flag</td>
<td>Sets all repair flags to attempt to fix all issues at once. <strong>Use with caution</strong></td>
<td>Not set</td>
<td>--fix</td>
</tr>
<tr class="row-even"><td>--compact</td>
<td>Flag</td>
<td>Compacts non-compacted rows during a repair.</td>
<td>Not Set</td>
<td>--compact</td>
</tr>
<tr class="row-odd"><td>--delete-bad-compacts</td>
<td>Flag</td>
<td>Removes columns that appear to be compacted but failed parsing. If a column parses properly but the final byte of the value is not set to a 0 or a 1, the column will be left alone.</td>
<td>Not Set</td>
<td>--delete-bad-compacts</td>
</tr>
<tr class="row-even"><td>--delete-bad-rows</td>
<td>Flag</td>
<td>Removes any row that doesn't match the OpenTSDB row key format of a metric UID followed by a timestamp and tag UIDs.</td>
<td>Not Set</td>
<td>--delete-bad-rows</td>
</tr>
<tr class="row-odd"><td>--delete-bad-values</td>
<td>Flag</td>
<td>Removes any stand-alone data points that could not be repaired or did not conform to the OpenTSDB specification.</td>
<td>Not Set</td>
<td>--delete-bad-values</td>
</tr>
<tr class="row-even"><td>--delete-orphans</td>
<td>Flag</td>
<td>Removes rows where one or more UIDs could not be resolved to a name.</td>
<td>Not Set</td>
<td>--delete-orphans</td>
</tr>
<tr class="row-odd"><td>--delete-unknown_columns</td>
<td>Flag</td>
<td>Removes any column that does not appear to be a compacted column, a stand-alone data point or a known or future OpenTSDB object.</td>
<td>Not Set</td>
<td>--delete-unknown-columns</td>
</tr>
<tr class="row-even"><td>--resolve-duplicates</td>
<td>Flag</td>
<td>Enables duplicate data point resolution by deleting all but the latest or oldest data point. Also see <tt class="docutils literal"><span class="pre">--last-write-wins</span></tt>.</td>
<td>Not Set</td>
<td>--resolve-duplicates</td>
</tr>
<tr class="row-odd"><td>--last-write-wins</td>
<td>Flag</td>
<td>When set, deletes all but the most recently written data point when resolving duplicates. If the config value <tt class="docutils literal"><span class="pre">tsd.storage.fix_duplicates</span></tt> is set to true, then the latest data point will be kept regardless of this value.</td>
<td>Not Set</td>
<td>--last-write-wins</td>
</tr>
<tr class="row-even"><td>--full-scan</td>
<td>Flag</td>
<td>Scans the entire data table. <strong>Note:</strong> This can take a very long time to complete.</td>
<td>Not Set</td>
<td>--full-scan</td>
</tr>
<tr class="row-odd"><td>--threads</td>
<td>Integer</td>
<td>The number of threads to use when performing a full scan. The default is twice the number of CPU cores.</td>
<td>2 x CPU Cores</td>
<td>--threads=16</td>
</tr>
<tr class="row-even"><td>START-DATE</td>
<td>String or Integer</td>
<td>Starting time for the query. This may be an absolute or relative time. See <a class="reference internal" href="../query/dates.html"><em>Dates and Times</em></a> for details</td>
<td>&nbsp;</td>
<td>1h-ago</td>
</tr>
<tr class="row-odd"><td>END-DATE</td>
<td>String or Integer</td>
<td>Optional end time for the query. If not provided, the current time is used. This may be an absolute or relative time. See <a class="reference internal" href="../query/dates.html"><em>Dates and Times</em></a> for details</td>
<td>Current timestamp</td>
<td>2014/01/01-00:00:00</td>
</tr>
<tr class="row-even"><td>query</td>
<td>String</td>
<td>One or more command line queries</td>
<td>&nbsp;</td>
<td>sum tsd.hbase.rpcs type=put</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="examples">
<h2>Examples</h2>
<p><strong>Query</strong></p>
<div class="highlight-bash"><div class="highlight"><pre>fsck --fix 1h-ago now sum tsd.hbase.rpcs <span class="nb">type</span><span class="o">=</span>put sum tsd.hbase.rpcs <span class="nb">type</span><span class="o">=</span>scan
</pre></div>
</div>
<p><strong>Full Table</strong></p>
<div class="highlight-bash"><div class="highlight"><pre>fsck --full-scan --threads<span class="o">=</span>8 --fix --resolve-duplicates --compact
</pre></div>
</div>
</div>
<div class="section" id="full-table-vs-queries">
<h2>Full Table Vs Queries</h2>
<p>Using the <tt class="docutils literal"><span class="pre">--full-scan</span></tt> flag, the entire OpenTSDB <tt class="docutils literal"><span class="pre">tsdb</span></tt> data table will be scanned. By default the utility will launch <tt class="docutils literal"><span class="pre">2</span> <span class="pre">x</span> <span class="pre">CPU</span> <span class="pre">core</span></tt> threads for optimal performance. Data is stored with the metric UID as the start of each row key so the utility will determine the maximum metric UID and split up the main data table equally among threads. If your data is distributed among metrics fairly evenly, then each thread should complete in roughly the same amount of time. However some metrics usually have more data or time series than others so these threads may be running much longer than others. Future updates to OpenTSDB will be able to divy up the workload in a more efficient manner.</p>
<p>Alternatively you can spcify a CLI query to fsck over a smaller timespan and look at a specific metric or time series. These queries will almost always complete much faster than a full scan and will uncover similar issues. However orphaned metrics will not found as the query will only operate on known time series. Orphans where tag names or values have been deleted will still be found.</p>
<p>Regardless of the method used, fsck only looks at the most recent column value in HBase. If the table is configured to store multiple versions, older versions of a column are ignored.</p>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>The results will be logged with settings in the <tt class="docutils literal"><span class="pre">logback.xml</span></tt> file. For long fscks, it's recommended to run in the background and configure LogBack to have plenty of space for writing data. On completion, statistics about the run will be printed. An example looks like:</p>
<div class="highlight-python"><div class="highlight"><pre>2014-07-07 13:09:15,610 INFO  [main] Fsck: Starting full table scan
2014-07-07 13:09:15,619 INFO  [main] Fsck: Max metric ID is [0]
2014-07-07 13:09:15,619 INFO  [main] Fsck: Spooling up [1] worker threads
2014-07-07 13:09:16,358 INFO  [main] Fsck: Thread [0] Finished
2014-07-07 13:09:16,358 INFO  [main] Fsck: Key Values Processed: 301
2014-07-07 13:09:16,358 INFO  [main] Fsck: Rows Processed: 1
2014-07-07 13:09:16,359 INFO  [main] Fsck: Valid Datapoints: 300
2014-07-07 13:09:16,359 INFO  [main] Fsck: Annotations: 1
2014-07-07 13:09:16,359 INFO  [main] Fsck: Invalid Row Keys Found: 0
2014-07-07 13:09:16,360 INFO  [main] Fsck: Invalid Rows Deleted: 0
2014-07-07 13:09:16,360 INFO  [main] Fsck: Duplicate Datapoints: 0
2014-07-07 13:09:16,360 INFO  [main] Fsck: Duplicate Datapoints Resolved: 0
2014-07-07 13:09:16,361 INFO  [main] Fsck: Orphaned UID Rows: 0
2014-07-07 13:09:16,361 INFO  [main] Fsck: Orphaned UID Rows Deleted: 0
2014-07-07 13:09:16,361 INFO  [main] Fsck: Possible Future Objects: 0
2014-07-07 13:09:16,362 INFO  [main] Fsck: Unknown Objects: 0
2014-07-07 13:09:16,362 INFO  [main] Fsck: Unknown Objects Deleted: 0
2014-07-07 13:09:16,362 INFO  [main] Fsck: Unparseable Datapoint Values: 0
2014-07-07 13:09:16,362 INFO  [main] Fsck: Unparseable Datapoint Values Deleted: 0
2014-07-07 13:09:16,363 INFO  [main] Fsck: Improperly Encoded Floating Point Values: 0
2014-07-07 13:09:16,363 INFO  [main] Fsck: Improperly Encoded Floating Point Values Fixed: 0
2014-07-07 13:09:16,363 INFO  [main] Fsck: Unparseable Compacted Columns: 0
2014-07-07 13:09:16,364 INFO  [main] Fsck: Unparseable Compacted Columns Deleted: 0
2014-07-07 13:09:16,364 INFO  [main] Fsck: Datapoints Qualified for VLE : 0
2014-07-07 13:09:16,364 INFO  [main] Fsck: Datapoints Compressed with VLE: 0
2014-07-07 13:09:16,365 INFO  [main] Fsck: Bytes Saved with VLE: 0
2014-07-07 13:09:16,365 INFO  [main] Fsck: Total Errors: 0
2014-07-07 13:09:16,366 INFO  [main] Fsck: Total Correctable Errors: 0
2014-07-07 13:09:16,366 INFO  [main] Fsck: Total Errors Fixed: 0
2014-07-07 13:09:16,366 INFO  [main] Fsck: Completed fsck in [1] seconds
</pre></div>
</div>
<p>For the most part, these statistics should be self-explanatory. <tt class="docutils literal"><span class="pre">Key</span> <span class="pre">Values</span> <span class="pre">Processed</span></tt> indicates the number of individual columns in HBase. <tt class="docutils literal"><span class="pre">VLE</span></tt> referse to <tt class="docutils literal"><span class="pre">variable</span> <span class="pre">length</span> <span class="pre">encoding</span></tt>.</p>
<p>During a run, progress will be reported every 5 seconds so that you know the utility is still working. You should see lines similar to the following:</p>
<div class="highlight-python"><div class="highlight"><pre>10:14:00.518 INFO  [Fsck.run] - Processed 47689680000 rows, 449891670779 valid datapoints
10:14:01.518 INFO  [Fsck.run] - Processed 47689730000 rows, 449892264237 valid datapoints
10:14:02.519 INFO  [Fsck.run] - Processed 47689780000 rows, 449892880333 valid datapoints
</pre></div>
</div>
<p>Any time an error is found (and possibly fixed), the log will be updated immediately. Errors will usually include the column where the error was found in the output. Byte arrays are represented in either Java style signed bytes, e.g. <tt class="docutils literal"><span class="pre">[0,</span> <span class="pre">1,</span> <span class="pre">-42]</span></tt> or hex encoded strings, e.g. <tt class="docutils literal"><span class="pre">00000000000000040000000000000005</span></tt>. Short-hand references include (k) for the row key, (q) for the qualifier and (v) for the value.</p>
</div>
<div class="section" id="types-of-errors-and-fixes">
<h2>Types of Errors and Fixes</h2>
<p>The following is a list of errors and/or fixes that can be found or performed with fsck.</p>
<div class="section" id="bad-row-keys">
<h3>Bad Row Keys</h3>
<p>If a row key is found that doesn't conform to the OpenTSDB data table specification <tt class="docutils literal"><span class="pre">&lt;metric_UID&gt;&lt;base_timestamp&gt;&lt;tagk1_UID&gt;&lt;tagv1_UID&gt;[...&lt;tagkn_UID&gt;&lt;tagvn_UID&gt;]</span></tt>, the entire row is considered invalid.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 15:03:46,483 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: Invalid row key.</span>
      Key: 000001
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>If <tt class="docutils literal"><span class="pre">--delete-bad-rows</span></tt> is set, then the entire row will be removed from HBase.</p>
</div>
<div class="section" id="orphaned-rows">
<h3>Orphaned Rows</h3>
<p>If a row key is parsed as a proper OpenTSDB row, then the UIDs for the time series ID (TSUID) of the row are resolved to their names. If any of the UIDs does not match a name in the <tt class="docutils literal"><span class="pre">tsdb-uid</span></tt> table, then the row is considered an orphan. This can happen if a UID is manually deleted from the UID table or a deletion does not complete properly.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 15:08:45,057 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: Unable to resolve the metric from the row key.</span>
      Key: 00000150E22700000001000001
      No such unique ID <span class="k">for</span> <span class="s1">&#39;metric&#39;</span>: <span class="o">[</span>0, 0, 1<span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>If <tt class="docutils literal"><span class="pre">--delete-orphans</span></tt> is set, then the entire row will be removed from HBase.</p>
</div>
<div class="section" id="compact-row">
<h3>Compact Row</h3>
<p>While it's not strictly an error, fsck can be used to compact rows into a single column. Compacting rows saves storage space by merging multiple columns into one. This cuts down on HBase overhead. If a TSD that is configured to compact columns crashes, some rows may be missed and remain in stand-alone data point form. As compaction can consume resources, you can use fsck to compact rows when the load on your cluster is reduced.</p>
<p>Specifying the <tt class="docutils literal"><span class="pre">--compact</span></tt> flag along with <tt class="docutils literal"><span class="pre">--fix</span></tt> will compact any row that has stand-alone data points within the query range. During compaction, any data points from old OpenTSDB versions that qualify for VLE will be re-encoded.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a row is repaired for any reason and has one or more compacted columns, the row will be re-compacted regardless of the <tt class="docutils literal"><span class="pre">--compact</span></tt> flag.</p>
</div>
</div>
<div class="section" id="bad-compacted-column-error">
<h3>Bad Compacted Column Error</h3>
<p>These errors occur when compacted column is found that cannot be parsed into individual data points. This can happen if the qualifier appears correct but the number of bytes in the value array do not match the lengths encoded in the qualifier. Compacted columns with their data points out of order are not considered bad columns. Instead, the column will be sorted properly and re-written if the <tt class="docutils literal"><span class="pre">--fix</span></tt> or <tt class="docutils literal"><span class="pre">--fix-all</span></tt> flags are present.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 13:29:40,251 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: Corrupted value: couldn&#39;t break down into individual values (consumed 20 bytes, but was expecting to consume 24): [k &#39;00000150E22700000001000001&#39; q &#39;000700270033&#39; v &#39;00000000000000040000000000000005000000000000000600&#39;], cells so far: [Cell([0, 7], [0, 0, 0, 0, 0, 0, 0, 4]), Cell([0, 39], [0, 0, 0, 0, 0, 0, 0, 5]), Cell([0, 51], [0, 0, 0, 0])]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>The only fix for this error is to delete the column by specifying the <tt class="docutils literal"><span class="pre">--delete-bad-compacts</span></tt> flag.</p>
</div>
<div class="section" id="compacted-last-byte-error">
<h3>Compacted Last Byte Error</h3>
<p>The last byte of a compacted value is for storing meta data. It will usually be <tt class="docutils literal"><span class="pre">0</span></tt> if all of the data points are encoded in seconds or milliseconds. If there is a mixture of seconds and milliseconds will be set to <tt class="docutils literal"><span class="pre">1</span></tt>. If the value is something else then it may be from a future version of OpenTSDB or the column may be invalid.</p>
<div class="highlight-bash"><div class="highlight"><pre>18:13:35.979 <span class="o">[</span>main<span class="o">]</span> ERROR net.opentsdb.tools.Fsck - The last byte of a compacted should be 0 or 1. Either this value is corrupted or it was written by a future version of OpenTSDB.
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;00070027&#39;</span> v <span class="s1">&#39;00000000000000040000000000000005&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>Currently this is not repaired. You can manually set the last byte to 0 or 1 to prevent the error from being thrown. The <tt class="docutils literal"><span class="pre">--delete-bad-compacts</span></tt> flag will not remove these columns.</p>
</div>
<div class="section" id="value-too-long-or-short">
<h3>Value Too Long Or Short</h3>
<p>This may occur if a value is recorded on greater than 8 bytes for a single data point column. Individual data points are stored on 2 or 4 byte qualifiers. This error cannot happen for a data point within a compacted column. If it was compacted, the column would throw a bad compacted column error as it wouldn't be parseable.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 14:50:44,022 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: This floating point value must be encoded either on 4 or 8 bytes, but it&#39;s on 9 bytes.</span>
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;F000020B&#39;</span> v <span class="s1">&#39;000000000000000005&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p><tt class="docutils literal"><span class="pre">--delete-bad-values</span></tt> will remove the column.</p>
</div>
<div class="section" id="old-version-floats">
<h3>Old Version Floats</h3>
<p>Early OpenTSDB versions had a bug in the floating point value storage where the first 4 bytes of an 8 byte value were written with all bits set to 1. The value should be on the last four bytes as the qualifier encodes the length as four bytes. However if the invalid data was compacted, the data cannot be parsed properly and an error will be recorded.</p>
<div class="highlight-bash"><div class="highlight"><pre>18:43:35.297 <span class="o">[</span>main<span class="o">]</span> ERROR net.opentsdb.tools.Fsck - Floating point value with 0xFF most significant bytes, probably caused by sign extension bug present in revisions <span class="o">[</span>96908436..607256fc<span class="o">]</span>.
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;002B&#39;</span> v <span class="s1">&#39;FFFFFFFF43FA6666&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>The <tt class="docutils literal"><span class="pre">--fix</span></tt> flag will repair these errors by rewriting the value without the first four bytes. The qualifier remains unchanged.</p>
</div>
<div class="section" id="byte-floats-with-8-byte-value-ok">
<h3>4 Byte Floats with 8 Byte Value OK</h3>
<p>Some versions of OpenTSDB may have encoded floating point values on 8 bytes when setting the qualifier length to 4 bytes. The first four bytes should be 0. If the value was compacted, the compacted column will be invalid as parsing is no longer possible.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 14:33:34,498 WARN  <span class="o">[</span>Fsck <span class="c">#0] Fsck: Floating point value was marked as 4 bytes long but was actually 8 bytes long</span>
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;000B&#39;</span> v <span class="s1">&#39;0000000040866666&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>The <tt class="docutils literal"><span class="pre">--fix</span></tt> flag will repair these errors by rewriting the value without the first four bytes. The qualifier remains unchanged.</p>
</div>
<div class="section" id="byte-floats-with-8-byte-value-bad">
<h3>4 Byte Floats with 8 Byte Value Bad</h3>
<p>In this case a value was encoded on 8 bytes with the first four bytes set to a non-zero value. It could be that the value is an 8 byte double since OpenTSDB never actually encoded on 8 bytes, the value is likely corrupt. If the value was compacted, the compacted column will be invalid as parsing is no longer possible.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 14:37:02,717 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: Floating point value was marked as 4 bytes long but was actually 8 bytes long and the first four bytes were not zeroed</span>
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;002B&#39;</span> v <span class="s1">&#39;FB02F40F43FA6666&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>The <tt class="docutils literal"><span class="pre">--delete-bad-values</span></tt> flag will remove the column. You could try parsing the value as a Double manually and see if it looks valid, otherwise it's likely a corrupt column.</p>
</div>
<div class="section" id="unknown-object">
<h3>Unknown Object</h3>
<p>OpenTSDB 2.0 supports objects such as annotations in the data table. If a column is found that doesn't match an OpenTSDB object, a compacted column or a stand-alone data point, it is considered an unknown object and can likely be deleted.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 14:55:03,019 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: Unknown qualifier, must be 2, 3, 5 or an even number of bytes.</span>
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;00270401010101&#39;</span> v <span class="s1">&#39;0000000000000005&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>The <tt class="docutils literal"><span class="pre">--delete-unknown-columns</span></tt> flag will remove this column from the row.</p>
</div>
<div class="section" id="future-object">
<h3>Future Object</h3>
<p>Objects are encoded on 3 or 5 byte qualifiers and the type is determined by a prefix. If a prefix is found that OpenTSDB doesn't recognize, then it will report the object but it will not be deleted. Note that this may actually be an unknown or corrupted column as fsck only looks at the qualifier length and the first byte of the qualifier. If that is the case, you can safely delete this column manually.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 14:57:15,858 WARN  <span class="o">[</span>Fsck <span class="c">#0] Fsck: Found an object possibly from a future version of OpenTSDB</span>
      <span class="o">[</span>k <span class="s1">&#39;00000150E22700000001000001&#39;</span> q <span class="s1">&#39;042704&#39;</span> v <span class="s1">&#39;467574757265204F626A656374&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>Future objects are left alone during fsck. Querying over the data with a TSD that doesn't support the object will throw an exception but versions that do support the object should procede normally.</p>
</div>
<div class="section" id="duplicate-timestamps">
<h3>Duplicate Timestamps</h3>
<p>Due to the use of encoding length and type for datapoints in qualifiers, it's possible to record a data point for the same timestamp with two different qualifiers. For example if you post an integer value for time <tt class="docutils literal"><span class="pre">1</span></tt> and then post a float value for time <tt class="docutils literal"><span class="pre">1</span></tt>, two different columns will be created. Duplicates can also happen if a row has been compacted and the TSD writes a new stand-alone column that matches a timestamp in the compacted column. At query time, an exception will be thrown as TSD does not know which value is the correct one.</p>
<div class="highlight-bash"><div class="highlight"><pre>2014-07-07 15:22:43,231 ERROR <span class="o">[</span>Fsck <span class="c">#0] Fsck: More than one column had a value for the same timestamp: (1356998400000)</span>
  row key: <span class="o">(</span>00000150E22700000001000001<span class="o">)</span>
  write <span class="nb">time</span>: <span class="o">(</span>1388534400000<span class="o">)</span>  compacted: <span class="o">(</span><span class="nb">false</span><span class="o">)</span>  qualifier: <span class="o">[</span>0, 7<span class="o">]</span>  &lt;--- Keep oldest
  write <span class="nb">time</span>: <span class="o">(</span>1388534400001<span class="o">)</span>  compacted: <span class="o">(</span><span class="nb">false</span><span class="o">)</span>  qualifier: <span class="o">[</span>0, 11<span class="o">]</span>
  write <span class="nb">time</span>: <span class="o">(</span>1388534400002<span class="o">)</span>  compacted: <span class="o">(</span><span class="nb">false</span><span class="o">)</span>  qualifier: <span class="o">[</span>0, 3<span class="o">]</span>
  write <span class="nb">time</span>: <span class="o">(</span>1388534400003<span class="o">)</span>  compacted: <span class="o">(</span><span class="nb">false</span><span class="o">)</span>  qualifier: <span class="o">[</span>0, 1<span class="o">]</span>
</pre></div>
</div>
<p><em>Fix:</em></p>
<p>If <tt class="docutils literal"><span class="pre">--resolve-duplicates</span></tt> is set, then all data points except for the latest or the oldest value will be deleted. The fix applies to both stand-alone and compacted data points. If the <tt class="docutils literal"><span class="pre">--last-write-wins</span></tt> flag is set, then the latest value is saved. Without the <tt class="docutils literal"><span class="pre">--last-write-wins</span></tt> flag, then the oldest value is saved.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the <tt class="docutils literal"><span class="pre">tsd.storage.fix_duplicates</span></tt> configuration value is set to <tt class="docutils literal"><span class="pre">true</span></tt> then the latest value will be saved regardless of <tt class="docutils literal"><span class="pre">--last-write-wins</span></tt>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">With compactions enabled, it is possible (though unlikely) that a data point is written while a row is being compacted. In this case, the compacted column will have a <em>later</em> timestamp than a data point written during the compaction. Therefore the default result of <tt class="docutils literal"><span class="pre">--resolve-duplicates</span></tt> will keep the stand-alone data point or, if last writes win, then the compacted value.</p>
</div>
</div>
<div class="section" id="variable-length-encoding">
<h3>Variable-Length Encoding</h3>
<p>Early OpenTSDB implementations always encoded integer values on 8 bytes. With 2.0, integers were written on the smallest number of bytes possible, either 1, 2, 4 or 8. During fsck, any 8 byte encoded integers detected will be re-written with VLE if the <tt class="docutils literal"><span class="pre">--fix</span></tt> or <tt class="docutils literal"><span class="pre">--fix-all</span></tt> flags are specified. This includes stand-alone and compacted values. At the end of a run, the number of bytes saved with VLE are displayed.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="scan.html" title="scan"
             >next</a> |</li>
        <li class="right" >
          <a href="query.html" title="query"
             >previous</a> |</li>
        <li><a href="../../index.html">OpenTDSB 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >User Guide</a> &raquo;</li>
          <li><a href="index.html" >CLI Tools</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, OpenTSDB.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>. Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
  </body>
</html>