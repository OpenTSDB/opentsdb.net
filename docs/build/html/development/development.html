<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>General Development &mdash; OpenTDSB 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="OpenTDSB 2.0 documentation" href="../index.html" />
    <link rel="up" title="Development" href="index.html" />
    <link rel="next" title="Plugins" href="plugins.html" />
    <link rel="prev" title="Development" href="index.html" /><link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'>
<link href="../_static/solarized-dark.css" rel="stylesheet">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18339382-1']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="plugins.html" title="Plugins"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Development"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">OpenTDSB 2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Development</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">General Development</a><ul>
<li><a class="reference internal" href="#build-system">Build System</a></li>
<li><a class="reference internal" href="#building">Building</a><ul>
<li><a class="reference internal" href="#build-targets">Build Targets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-a-dependency">Adding a Dependency</a></li>
<li><a class="reference internal" href="#adding-removing-moving-a-class">Adding/Removing/Moving a Class</a></li>
<li><a class="reference internal" href="#ides">IDEs</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Development</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="plugins.html"
                        title="next chapter">Plugins</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="general-development">
<h1>General Development</h1>
<p>OpenTSDB isn't laid out like a typical Java project, instead it's a bit more like a C or C++ environment. This page is to help folks who want to modify OpenTSDB and provide updates back to the community.</p>
<div class="section" id="build-system">
<h2>Build System</h2>
<p>There are almost as many build systems as there are developers so it's impossible to satisfy everyone no matter which system or layout is chosen. Autotools and GNU Make were chosen early on for OpenTSDB because of their flexibility, portability, and especially speed and popular usage. It's not the easiest to configure but for our needs, it's really not too difficult. We'll spell out what you need to change below and give tips for IDE users who want to setup an environment. Note that the build script can now compile a <tt class="docutils literal"><span class="pre">pom.xml</span></tt> file for compiling with Maven and work is underway to provide better Maven support. However you still have to modify <tt class="docutils literal"><span class="pre">Makefile.am</span></tt> if you add or remove classes or dependencies and such.</p>
</div>
<div class="section" id="building">
<h2>Building</h2>
<p>OpenTSDB is built using the standard <tt class="docutils literal"><span class="pre">./configure</span> <span class="pre">&amp;&amp;</span> <span class="pre">make</span></tt> model that is most commonly employed by many open-source projects. Fresh working copies checked out from Git must first be <tt class="docutils literal"><span class="pre">./bootstraped</span></tt>.</p>
<p>Alternatively, there is a <tt class="docutils literal"><span class="pre">build.sh</span></tt> script you can run that makes as it takes care of all the steps for you. You can give it a Make target in argument, e.g. <tt class="docutils literal"><span class="pre">./build.sh</span> <span class="pre">distcheck</span></tt> (the default target is <tt class="docutils literal"><span class="pre">all</span></tt>).</p>
<div class="section" id="build-targets">
<h3>Build Targets</h3>
<p>The <tt class="docutils literal"><span class="pre">build.sh</span></tt> script will compile a JAR and the static GWT files for the front-end GUI if no parameters are passed. Additional parameters include:</p>
<ul class="simple">
<li><strong>check</strong> - Executes unit tests and reports on the results. You can specify executing the checks in a specific file via <tt class="docutils literal"><span class="pre">test_SRC=&lt;path&gt;</span></tt>, e.g. <tt class="docutils literal"><span class="pre">./build.sh</span> <span class="pre">check</span> <span class="pre">test_SRC=test/uid/TestNoSuchUniqueId.java</span></tt></li>
<li><strong>pom.xml</strong> - Compile a POM file to compile with Maven.</li>
<li><strong>dist</strong> - Downloads dependencies, compiles OpenTSDB and creates a tarball for distribution</li>
<li><strong>distcheck</strong> - Same as dist but also runs unit tests. This should be run before issuing pull requests to verify that everything performs correctly.</li>
<li><strong>debian</strong> - Compiles OpenTSDB and generates a Debian package</li>
</ul>
</div>
</div>
<div class="section" id="adding-a-dependency">
<h2>Adding a Dependency</h2>
<p><em>Please try your best not to</em>. We're extremely picky on the dependencies and will require a code review before we start depending on a new library. The goal isn't to re-invent the wheel either, but we are very mindful about the number and quality of dependent libraries we pull in.
If you absolutely must add a new dependency, here are the steps:</p>
<ul>
<li><p class="first">Find the canonical source to download the dependent JAR file</p>
</li>
<li><p class="first">Find or create the proper directory under <tt class="docutils literal"><span class="pre">third_party/</span></tt></p>
</li>
<li><p class="first">In that directory, create a <tt class="docutils literal"><span class="pre">&lt;depdencency&gt;.jar.md5</span></tt> file</p>
</li>
<li><p class="first">Paste the MD5 hash of the entire jar in that file and save it</p>
</li>
<li><p class="first">Create or edit the <tt class="docutils literal"><span class="pre">include.mk</span></tt> file and copy the header info from another directory's file</p>
</li>
<li><p class="first">Add a <tt class="docutils literal"><span class="pre">&lt;DEPENDENCY&gt;_VERSION</span> <span class="pre">:=</span> <span class="pre">&lt;version&gt;</span></tt> e.g. <tt class="docutils literal"><span class="pre">JACKSON_VERSION</span> <span class="pre">:=</span> <span class="pre">1.9.4</span></tt></p>
</li>
<li><p class="first">Add a <tt class="docutils literal"><span class="pre">&lt;DEPENDENCY&gt;</span> <span class="pre">:=</span> <span class="pre">third_parth/&lt;DIR&gt;/&lt;dependency&gt;$(&lt;DEPENDENCY&gt;_VERSION).jar</span></tt> line e.g. <tt class="docutils literal"><span class="pre">JACKSON_CORE</span> <span class="pre">:=</span> <span class="pre">third_party/jackson/jackson-core-lgpl-$(JACKSON_CORE_VERSION).jar</span></tt></p>
</li>
<li><p class="first">Add the canonical source URL in the format <tt class="docutils literal"><span class="pre">&lt;DEPENDENCY&gt;_BASE_URL</span> <span class="pre">:=</span> <span class="pre">&lt;URL&gt;</span></tt> e.g. <tt class="docutils literal"><span class="pre">JACKSON_CORE_BASE_URL</span> <span class="pre">:=</span> <span class="pre">http://repository.codehaus.org/org/codehaus/jackson/jackson-core-lgpl/$(JACKSON_VERSION)</span></tt> and note that the JAR name will be appended to the end of the URL</p>
</li>
<li><p class="first">Add the following lines</p>
<div class="highlight-python"><div class="highlight"><pre>$(&lt;DEPENDENCY&gt;): $(J&lt;DEPENDENCY&gt;).md5
set dummy ``$(&lt;DEPENDENCY&gt;_BASE_URL)`` ``$(&lt;DEPENDENCY&gt;)``; shift; $(FETCH_DEPENDENCY)
</pre></div>
</div>
<p>e.g.</p>
<div class="highlight-python"><div class="highlight"><pre>$(JACKSON_CORE): $(JACKSON_CORE).md5
set dummy ``$(JACKSON_CORE_BASE_URL)`` ``$(JACKSON_CORE)``; shift; $(FETCH_DEPENDENCY)
</pre></div>
</div>
</li>
<li><p class="first">Add a line <tt class="docutils literal"><span class="pre">THIRD_PARTY</span> <span class="pre">+=</span> <span class="pre">$(&lt;DEPENDENCY&gt;)</span></tt> e.g. <tt class="docutils literal"><span class="pre">THIRD_PARTY</span> <span class="pre">+=</span> <span class="pre">$(JACKSON_CORE)</span></tt></p>
</li>
<li><p class="first">Next, back in the <tt class="docutils literal"><span class="pre">third_party/</span></tt> directory, edit the <tt class="docutils literal"><span class="pre">include.mk</span></tt> file and if you added a new directory for your dependency, insert a reference to the <tt class="docutils literal"><span class="pre">.mk</span></tt> file in the proper alphabetical position.</p>
</li>
<li><p class="first">Edit <tt class="docutils literal"><span class="pre">Makefile.am</span></tt></p>
<ul>
<li><p class="first">Find the <tt class="docutils literal"><span class="pre">tsdb_DEPS</span> <span class="pre">=</span> <span class="pre">\</span></tt> line</p>
</li>
<li><p class="first">Add your new dependency in the proper alphabetical position in the format <tt class="docutils literal"><span class="pre">$(&lt;DEPENDENCY&gt;)</span></tt>, e.g. <tt class="docutils literal"><span class="pre">$(JACKSON_CORE&gt;</span></tt>. Note that if you put it the middle of the list, you must finish with the line continuation character, the backslash <tt class="docutils literal"><span class="pre">\</span></tt>. If your dependency goes at the end, do not add the backslash.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the dependency is only used for unit tests, then add it to the <tt class="docutils literal"><span class="pre">test_DEPS</span> <span class="pre">=</span> <span class="pre">\</span></tt> list</p>
</div>
</li>
<li><p class="first">Find the <tt class="docutils literal"><span class="pre">pom.xml:</span> <span class="pre">pom.xml.in</span> <span class="pre">Makefile</span></tt> line in the file</p>
</li>
<li><p class="first">Add a sed line such as <tt class="docutils literal"><span class="pre">-e</span> <span class="pre">'s/&#64;&lt;DEPENDENCY&gt;_VERSION&#64;/$(&lt;DEPENDENCY&gt;_VERSION)/'</span> <span class="pre">\</span></tt> e.g. <tt class="docutils literal"><span class="pre">-e</span> <span class="pre">'s/&#64;JACKSON_VERSION&#64;/$(JACKSON_VERSION)/'</span> <span class="pre">\</span></tt></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unit test dependencies go here as well as regular items</p>
</div>
</li>
</ul>
</li>
<li><p class="first">Edit <tt class="docutils literal"><span class="pre">pom.xml.in</span></tt></p>
<ul class="simple">
<li>Find the <tt class="docutils literal"><span class="pre">&lt;dependencies&gt;</span></tt> XML section</li>
<li>Copy and paste an existing dependency section and modify it for your variables</li>
</ul>
</li>
<li><p class="first">Now run a build via <tt class="docutils literal"><span class="pre">./build.sh</span></tt> and verify that it fetches your dependency and builds without errors. * Then run <tt class="docutils literal"><span class="pre">./build.sh</span> <span class="pre">pom.xml</span></tt> to verify that the POM is compiled properly and run a <tt class="docutils literal"><span class="pre">mvn</span> <span class="pre">compile</span></tt> to verify the Maven build works correctly.</p>
</li>
</ul>
</div>
<div class="section" id="adding-removing-moving-a-class">
<h2>Adding/Removing/Moving a Class</h2>
<p>This is much easier than dealing with a dependency. You only need to modify <tt class="docutils literal"><span class="pre">Makefile.am</span></tt> and edit the <tt class="docutils literal"><span class="pre">tsdb_SRC</span> <span class="pre">:=</span> <span class="pre">\</span></tt> or the <tt class="docutils literal"><span class="pre">test_SRC</span> <span class="pre">:=</span> <span class="pre">\</span></tt> lists. If you're adding a class, put it in the proper alphabetical position and account for the proper directory and class name. It is case sensitive so make sure to get that right. If removing a class, just delete the line. If moving a class, add the new line and delete the old one. Be careful to handle the line continuation <tt class="docutils literal"><span class="pre">\</span></tt> backslashes. The last class in each list should NOT end with a backslash, the rest need it.</p>
<p>After editing, rebuild with <tt class="docutils literal"><span class="pre">./build.sh</span></tt> and verify that your class was compiled and included properly.</p>
</div>
<div class="section" id="ides">
<h2>IDEs</h2>
<p>Many devs use an IDE to work on Java projects and despite OpenTSDB's non-java-standard directory layout, working with an IDE is pretty easy. Here are some steps to get up and running with Eclipse though they should work with other environments. This example assumes you're using Eclipse.</p>
<ul class="simple">
<li>Cone the GIT repo to a location such as <tt class="docutils literal"><span class="pre">/home/$USER/opentsdb</span></tt></li>
<li>Build the repo with <tt class="docutils literal"><span class="pre">./build.sh</span></tt> from the directory</li>
<li>Fire up Eclipse or your favorite IDE</li>
<li>Create a new Java project with a name like <tt class="docutils literal"><span class="pre">opentsdb_dev</span></tt> so that it winds up in <tt class="docutils literal"><span class="pre">/home/$USER/opentsdb_dev</span></tt></li>
<li>Your dev directory should now have a <tt class="docutils literal"><span class="pre">./src</span></tt> directory</li>
<li>Create a <tt class="docutils literal"><span class="pre">net</span></tt> directory under <tt class="docutils literal"><span class="pre">./src</span></tt> so that you have <tt class="docutils literal"><span class="pre">./src/net</span></tt> (some IDEs may create a <tt class="docutils literal"><span class="pre">./src/java</span></tt> dir, so add <tt class="docutils literal"><span class="pre">./src/java/net</span></tt>)</li>
<li>Create a symlink to the GIT repo's <tt class="docutils literal"><span class="pre">./src</span></tt> directory from <tt class="docutils literal"><span class="pre">./src/net/opentsdb</span></tt>. E.g. <tt class="docutils literal"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/home/$USER/opentsdb/src</span> <span class="pre">/home/$USER/opentsdb_dev/src/net/opentdsb</span></tt></li>
<li>Also, create a <tt class="docutils literal"><span class="pre">tsd</span></tt> directory under <tt class="docutils literal"><span class="pre">./src</span></tt> so that you have <tt class="docutils literal"><span class="pre">./src/tsd</span></tt></li>
<li>Create a symlink to the GIT repo's <tt class="docutils literal"><span class="pre">./src/tsd/client</span></tt> directory from <tt class="docutils literal"><span class="pre">./src/tsd/client</span></tt>. E.g. <tt class="docutils literal"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/home/$USER/opentsdb/src/tsd/client</span> <span class="pre">/home/$USER/opentsdb_dev/src/tsd/client</span></tt></li>
<li>If your IDE didn't, create a <tt class="docutils literal"><span class="pre">./test</span></tt> directory under your dev project folder. This will be used for unit tests.</li>
<li>Add a <tt class="docutils literal"><span class="pre">net</span></tt> directory under <tt class="docutils literal"><span class="pre">./test</span></tt> so you have <tt class="docutils literal"><span class="pre">./test/net</span></tt></li>
<li>Create a symlink to the GIT repo's <tt class="docutils literal"><span class="pre">./test</span></tt> directory from <tt class="docutils literal"><span class="pre">./test/net/opentsdb</span></tt>. E.g. <tt class="docutils literal"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/home/$USER/opentsdb/test</span> <span class="pre">/home/$USER/opentsdb_dev/test/net/opentdsb</span></tt></li>
<li>Refresh the directory lists in Eclipse and you should see all of the source files</li>
<li>Right click the <tt class="docutils literal"><span class="pre">net.opentsdb.tsd.client</span></tt> package under SRC and select <tt class="docutils literal"><span class="pre">Build</span> <span class="pre">Path</span></tt> then <tt class="docutils literal"><span class="pre">Exclude</span></tt> from the menu</li>
<li>Now add the downloaded dependencies by clicking Project -&gt; Properties, click the <tt class="docutils literal"><span class="pre">Java</span> <span class="pre">Build</span> <span class="pre">Path</span></tt> menu item and click <tt class="docutils literal"><span class="pre">Add</span> <span class="pre">External</span> <span class="pre">JARs</span></tt> button.</li>
<li>Do that for each of the dependencies that were downloaded by the build script</li>
<li>Copy the file <tt class="docutils literal"><span class="pre">./build/src/BuildData.java</span></tt> from the GIT repo, post build, to your <tt class="docutils literal"><span class="pre">./src/net/opentsdb/</span></tt> directory</li>
<li>Now click Run (or Debug) -&gt; Manage Configurations</li>
<li>Under Java Application, right click and select New from the pop-up</li>
<li>Under the Main tab, brows to your <tt class="docutils literal"><span class="pre">opentsdb_dev</span></tt> project</li>
<li>For the Main Class, search for <tt class="docutils literal"><span class="pre">net.opentsdb.tools.TSDMain</span></tt></li>
<li>Under Arguments, add the runtime arguments to select your Zookeeper quorum and the static and cache directories</li>
<li>Run or Debug it and hopefully it worked</li>
<li>Now edit away and when you're ready to publish changes, follow the directions above about modifying the build system (if necessary), publish to your own GitHub fork, and issue a pull request.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This won't compile the GWT UI. If you want to do UI work and have made changes, recompile OpenTSDB or export it as a JAR from your IDE, then execute the following command (assuming the directory structure above):</p>
<div class="last highlight-python"><div class="highlight"><pre>java -cp ``&lt;PATH_TO&gt;gwt-dev-2.4.0.jar;&lt;PATH_TO&gt;gwt-user-2.4.0.jar;&lt;PATH_TO&gt;tsdb-1.1.0.jar;/home/$USER/opentsdb/src/net/opentsdb;/home/$USER/opentsdb/src`` com.google.gwt.dev.Compiler -ea -war &lt;PATH_TO_STATIC_DIRECTORY&gt; tsd.Queryui
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="plugins.html" title="Plugins"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Development"
             >previous</a> |</li>
        <li><a href="../index.html">OpenTDSB 2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Development</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, OpenTSDB.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>. Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
  </body>
</html>