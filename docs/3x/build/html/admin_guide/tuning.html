<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tuning &#8212; OpenTSDB 3.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          OpenTSDB</a>
        <span class="navbar-text navbar-version pull-left"><b>3.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/OpenTSDB/opentsdb/releases">Download</a></li>
                <li><a href="https://github.com/OpenTSDB/opentsdb">Source</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">Changes in 3.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../changes.html#new-features">New Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changes.html#whats-missing">Whats Missing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation and Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#runtime-requirements">Runtime Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#compile">Compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#local">Local</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id1">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#querying">Querying</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">Users Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/semanticquery/index.html">Semantic Query (Version 3)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Administrators Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">TSDB Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_http/index.html">HTTP API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#version-2-x-to-3-x">Version 2.X to 3.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#authentication-permissions">Authentication/Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#response-codes">Response Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#verbs">Verbs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#query-string-vs-body-content">Query String Vs. Body Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#compressed-requests">Compressed Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#cors">CORS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#deprecated-api">Deprecated API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#api-endpoints">API Endpoints</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Tuning</a><ul>
<li><a class="reference internal" href="#tsdb-memory">TSDB Memory</a><ul>
<li><a class="reference internal" href="#uid-caches">UID Caches</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hbase-storage">HBase Storage</a><ul>
<li><a class="reference internal" href="#date-tierd-compaction">Date Tierd Compaction</a></li>
<li><a class="reference internal" href="#hbase-read-write-queues">HBase Read/Write Queues</a></li>
<li><a class="reference internal" href="#hbase-cache">HBase Cache</a></li>
<li><a class="reference internal" href="#hbase-compaction">HBase Compaction</a></li>
<li><a class="reference internal" href="#hbase-regions">HBase Regions</a></li>
<li><a class="reference internal" href="#hbase-memstore">HBase Memstore</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="tuning">
<h1>Tuning</h1>
<p id="index-0">As with any database there are many tuning parameters for OpenTSDB that can be used to improve write and read performance. Some of these options are specific to certain backends, others are global.</p>
<div class="section" id="tsdb-memory">
<h2>TSDB Memory</h2>
<p>As with any server process, tuning the TSD’s memory footprint is important for a successful install. There are a number of caches in OpenTSDB that can be tuned.</p>
<div class="section" id="uid-caches">
<h3>UID Caches</h3>
<p>OpenTSDB saves space in storage by converting strings to binary UIDs. However for writing and querying, these UIDs have to be cached to improve performance (otherwise every operation would amplify queries against storage). In early versions of OpenTSDB, the cache would maintain an unbounded map of strings to UIDs and UIDs to strings regardless of modes of operation. In 2.4 you can choose how much data to cache and optionally use an LRU. The pertinent settings include:</p>
<ul class="simple">
<li><p>‘tsd.uid.use_mode=true’ - When this is set to true, the <cite>tsd.mode</cite> value is examined to determine if either or both of the forward (string to UID) and reverse (UID to string) maps are populated. When empty or set to <cite>rw</cite>, both maps are populated. When set to <cite>ro</cite>, only the reverse map is populated (as query results need caching). When in <cite>w</cite> or write-only mode, only the forward map is populated as metrics need to find their UIDs when writing.</p></li>
<li><p><cite>tsd.uid.lru.enable=true</cite> - Switch to the LRU version of the cache that will expire entries that haven’t been read in a while.</p></li>
<li><p><cite>tsd.uid.lru.id.size=&lt;integer&gt;</cite> - For TSDs focused on reads, set this size larger than <cite>tsd.uid.lru.name.size</cite>.</p></li>
<li><p><cite>tsd.uid.lru.name.size=&lt;integer&gt;</cite> - For TSDs focused on writes, set this size larger than the <cite>tsd.uid.lru.id.size</cite>.</p></li>
</ul>
</div>
</div>
<div class="section" id="hbase-storage">
<h2>HBase Storage</h2>
<p>These are parameters to look at for using OpenTSDB with Apache HBase.</p>
<div class="section" id="date-tierd-compaction">
<span id="id1"></span><h3>Date Tierd Compaction</h3>
<p>HBase is an LSM store meaning data is written to blocks in memory, then flushed in blocks to disk, then periodically those blocks on disk are merged into fewer blocks to reduce file count and redundancies. The process of reading and merging blocks from disk can consume a fair amount of CPU and memory so if a system is heavily loaded with time series write traffic, background compactions can begin to impact write performance. HBase offers various compaction strategies including Date Tiered Compaction that looks at the the edit timestamps of columns to figure out if stale file that haven’t been modified should be ignored and arranges data so that time ranged queries are much more efficient.</p>
<p>OpenTSDB can leverage this compaction strategy (as of 2.4) to improve HBase performance, particularly for queries. To setup Date Tiered Compaction in HBase, see <a class="reference external" href="http://hbase.apache.org/book.html#ops.date.tiered">HBase Book</a>. Parameters that must be set in the OpenTSDB config include:</p>
<ul class="simple">
<li><p><cite>tsd.storage.use_otsdb_timestamp=true</cite> - By default the edit timestamps of every data point is <cite>now</cite>. This changes the timestamp to be that of the actual data point. Note that rollups do not use this strategy yet.</p></li>
<li><p><cite>tsd.storage.get_date_tiered_compaction_start=&lt;Unix Epoch MS timestamp&gt;</cite> - A timestamp in milliseconds when the date tiered compactor was enabled on a table. If you are creating a brand new table for OpenTSDB you can leave this at the default of <cite>0</cite>.</p></li>
</ul>
</div>
<div class="section" id="hbase-read-write-queues">
<h3>HBase Read/Write Queues</h3>
<p>HBase has the ability to split the queues that handle RPCs for writes (mutations) and reads. This is a huge help for OpenTSDB as massive queries will avoid impacting writes and vice-versa. See the <a class="reference external" href="http://hbase.apache.org/book.html#_tuning_code_callqueue_code_options">HBase Book</a> for various configuration options. Note that different HBase versions have different names for these properties.</p>
<p>Possible starting values are 50% or 60%. E.g. <cite>hbase.ipc.server.callqueue.read.share=0.60</cite> or <cite>hbase.ipc.server.callqueue.read.ratio=0.60</cite> depending on HBase version.</p>
<p>Also, tuning the call queue size and threads is important. With a large queue, the region server can possibly OOM (if there are a large number of writes backing up) and RPCs will be more likely to time out on the client side if they sit in the queue too long. The queue size is a factor of the number of handlers. Reducing the call queue size also helps to cause clients to throttle, particularly the AsyncHBase client. For HBase 1.3 a good setting may be <cite>hbase.ipc.server.max.callqueue.length=100</cite> and <cite>hbase.ipc.server.read.threadpool.size=2</cite>. If you need to increase the threads, reduce the queue length as well.</p>
</div>
<div class="section" id="hbase-cache">
<h3>HBase Cache</h3>
<p>Tuning the HBase cache is also important for queries as you want to avoid reading data off disk as much as possible (particularly if that disk is S3). Try using the offheap cache via <cite>hbase.bucketcache.combinedcache.enabled=true</cite> and <cite>hbase.bucketcache.ioengine=offheap</cite>. Give the offheap cache a good amount of RAM, e.g. <cite>hbase.bucketcache.size=4000</cite> for 4GB of RAM. Since the most recent data is usually queried when reading time series, it’s a good idea to populate the block cache on writes and use most of that space for the latest data. Try the following settings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hbase</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">cacheblocksonwrite</span><span class="o">=</span><span class="n">true</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">evictblocksonclose</span><span class="o">=</span><span class="n">false</span>
<span class="n">hfile</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">bloom</span><span class="o">.</span><span class="n">cacheonwrite</span><span class="o">=</span><span class="n">true</span>
<span class="n">hfile</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">cacheonwrite</span><span class="o">=</span><span class="n">true</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cachecompressed</span><span class="o">=</span><span class="n">true</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">bucketcache</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">percentage</span><span class="o">=.</span><span class="mi">99</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">bucketcache</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">percentage</span><span class="o">=</span><span class="mi">0</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">bucketcache</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">percentage</span><span class="o">=.</span><span class="mi">01</span>
<span class="n">hfile</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">size</span><span class="o">=.</span><span class="mi">054</span> <span class="c1">#ignored but needs a value.</span>
</pre></div>
</div>
<p>This will allocate the majority of the black cache for writes and cache it in memory.</p>
<p>For the on-heap cache, you can try an allocation of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hbase</span><span class="o">.</span><span class="n">lru</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">percentage</span><span class="o">=.</span><span class="mi">50</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">lru</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">percentage</span><span class="o">=.</span><span class="mi">49</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">lru</span><span class="o">.</span><span class="n">blockcache</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">percentage</span><span class="o">=.</span><span class="mi">01</span>
</pre></div>
</div>
</div>
<div class="section" id="hbase-compaction">
<h3>HBase Compaction</h3>
<p>Compaction is the process of merging multiple stores on disk for a region into fewer files to reduce space and query times. You can tune the number of threads and thresholds for compaction to avoid using too many resources when the focus should be on writes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hbase</span><span class="o">.</span><span class="n">hstore</span><span class="o">.</span><span class="n">compaction</span><span class="o">.</span><span class="n">ratio</span><span class="o">=</span><span class="mf">1.2</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">regionserver</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">compaction</span><span class="o">.</span><span class="n">large</span><span class="o">=</span><span class="mi">2</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">regionserver</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">compaction</span><span class="o">.</span><span class="n">small</span><span class="o">=</span><span class="mi">6</span>
<span class="n">hbase</span><span class="o">.</span><span class="n">regionserver</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">compaction</span><span class="o">.</span><span class="n">throttle</span><span class="o">=</span><span class="mi">524288000</span>
</pre></div>
</div>
</div>
<div class="section" id="hbase-regions">
<h3>HBase Regions</h3>
<p>For OpenTSDB we’ve observed that 10G regions are a good size for a large cluster <cite>hbase.hregion.max.filesize=10737418240</cite>.</p>
</div>
<div class="section" id="hbase-memstore">
<h3>HBase Memstore</h3>
<p>Try flushing the mem store to disk (and cache) more often, particularly for heavy write loads. We’ve seen good behavior with 16MBs <cite>hbase.hregion.memstore.flush.size=16777216</cite>. Also try reducing the memstore size limit via <cite>hbase.regionserver.global.memstore.lowerLimit=.20</cite> and <cite>hbase.regionserver.global.memstore.upperLimit=.30</cite>.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2021, OpenTSDB.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>