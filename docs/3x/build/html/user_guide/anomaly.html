<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anomaly Detection &#8212; OpenTSDB 3.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="EGADS: Olympic Scoring" href="plugins/olympicscoring.html" />
    <link rel="prev" title="/api/query/graph" href="../api_http/query/graph.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          OpenTSDB</a>
        <span class="navbar-text navbar-version pull-left"><b>3.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/OpenTSDB/opentsdb/releases">Download</a></li>
                <li><a href="https://github.com/OpenTSDB/opentsdb">Source</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../changes.html">Changes in 3.0</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../changes.html#new-features">New Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changes.html#whats-missing">Whats Missing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation and Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#runtime-requirements">Runtime Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#compile">Compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#local">Local</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id1">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#querying">Querying</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Users Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#querying-data">Querying Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#writing-data">Writing Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/index.html">Administrators Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/configuration.html">TSDB Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/logging.html">Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_http/index.html">HTTP API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#version-2-x-to-3-x">Version 2.X to 3.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#authentication-permissions">Authentication/Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#response-codes">Response Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#verbs">Verbs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#query-string-vs-body-content">Query String Vs. Body Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#compressed-requests">Compressed Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#cors">CORS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#deprecated-api">Deprecated API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_http/index.html#api-endpoints">API Endpoints</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../api_http/query/graph.html" title="Previous Chapter: /api/query/graph"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; /api/query/graph</span>
    </a>
  </li>
  <li>
    <a href="plugins/olympicscoring.html" title="Next Chapter: EGADS: Olympic Scoring"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">EGADS: Olympi... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Anomaly Detection</a><ul>
<li><a class="reference internal" href="#query-flow">Query Flow</a></li>
<li><a class="reference internal" href="#query-modes">Query Modes</a><ul>
<li><a class="reference internal" href="#config">CONFIG</a></li>
<li><a class="reference internal" href="#evaluate">EVALUATE</a></li>
<li><a class="reference internal" href="#predict">PREDICT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#common-semantic-query-fields">Common Semantic Query Fields</a></li>
<li><a class="reference internal" href="#output">Output</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="anomaly-detection">
<h1>Anomaly Detection</h1>
<p>Forecasting or anomaly detection is useful when working over time series data that involves “seasonality” or cyclical patterns usually related to human behavior, e.g. people streaming content at the end of a work day. OpenTSDB supports plugins that can analyze stored time series data and process it through algorithms to predict what should happen next. Users can then plot the data to compare against real values or alerting systems can notify users when thresholds have been exceeded.</p>
<p>Plugins available for anomaly processing include:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/olympicscoring.html">EGADS: Olympic Scoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/prophet.html">Facebook Prophet</a></li>
</ul>
</div>
<div class="section" id="query-flow">
<h2>Query Flow</h2>
<p>Predicting the future behavior of time series data is a non-trivial task whether it’s via a simple statistical algorithm or training machine learning models. To compute the forecast, a fair amount of historical data is needed, ranging from weeks to possibly years or more of information. Caching plays an important role in maintaining the performance of the query layer, thus there are multiple modes of anomaly query execution. OpenTSDB has support for various caching systems and strategies. See _TODO_</p>
</div>
<div class="section" id="query-modes">
<h2>Query Modes</h2>
<p>In the query config, these are the possible values for the <code class="docutils literal notranslate"><span class="pre">mode</span></code> field.</p>
<div class="section" id="config">
<h3>CONFIG</h3>
<p>In this mode, the prediction is not cached as it is intended for a user with a UI to modify algorithm settings until they find a fit that works for their use case. Each time a query is made the historical data is fetched and passed through the algorithms, thus this can be a heavy query.</p>
<p>A prediction for the entire query range is generated using historical data. The prediction can then be compared against the current data in the same query and anomalies can be serialized.</p>
<p>In the future we expect to cache the historical data (as long as the base query is not modified) for performance improvements but we’ll still have to train with the new settings.</p>
</div>
<div class="section" id="evaluate">
<h3>EVALUATE</h3>
<p>This is used for alerting where the prediction cache is read and/or populated for future calls. Similar to the config call, historical data is fetched on a prediction cache miss. Caches are populated for a day or an hour of data in segments. Current data within the query time range is compared against the predictions and anomalies detected can be serialized.</p>
</div>
<div class="section" id="predict">
<h3>PREDICT</h3>
<p>This mode can be used to pre-populate the cache instead of relying on the evaluate command. This is useful for very expensive queries where an evaluate call may timeout on a cache miss. (In that case the query keeps running in the background and the next call with an evaluate will hopfully find the cache populated.) Predict queries will return a 204 (or empty data set, TODO verify this).</p>
</div>
</div>
<div class="section" id="common-semantic-query-fields">
<h2>Common Semantic Query Fields</h2>
<p>Currently these anomaly algorithms are only supported in the semantic query layer and configuration nodes must be added to the execution graph. The following fields are common across all implementations.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 45%" />
<col style="width: 10%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mode</p></td>
<td><p>String</p></td>
<td><p>Required</p></td>
<td><p>One of <code class="docutils literal notranslate"><span class="pre">CONFIG</span></code>, <code class="docutils literal notranslate"><span class="pre">EVALUATE</span></code> or <code class="docutils literal notranslate"><span class="pre">PREDICT</span></code> to determine the behavior of the query.</p></td>
<td><p>null</p></td>
<td><p>CONFIG</p></td>
</tr>
<tr class="row-odd"><td><p>trainingInterval</p></td>
<td><p>String</p></td>
<td><p>Optional</p></td>
<td><p>A TSDB resolution that determines how far back in time to fetch historical data to train the model with.</p></td>
<td><p>null</p></td>
<td><p>3w</p></td>
</tr>
<tr class="row-even"><td><p>serializeObserved</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not to serialize the current or observed data. The metric and tag sets are unmodified.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>serializeThresholds</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not to serialize time series with computed thresholds applied. The <code class="docutils literal notranslate"><span class="pre">_anomalyModel</span></code> tag is added and the metric is suffixed with a period and the threshold, e.g. <code class="docutils literal notranslate"><span class="pre">.upperBad</span></code>. Only thresholds with values configured are serialized.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>serializeAlerts</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not to serialize the anomalies. See the section below.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>serializeDeltas</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>Whether or not to serialize the delta of the observed data from the predicted data. Tags include the <code class="docutils literal notranslate"><span class="pre">_anomalyModel</span></code> and the metric is suffixed with <code class="docutils literal notranslate"><span class="pre">.delta</span></code>.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>upperThresholdBad</p></td>
<td><p>Numeric</p></td>
<td><p>Optional</p></td>
<td><p>For anomaly detection, a numeric threshold that, when the delta of observed and predicted data exceeds the threshold, a <code class="docutils literal notranslate"><span class="pre">bad</span></code> anomaly is emitted.</p></td>
<td><p>null</p></td>
<td><p>25</p></td>
</tr>
<tr class="row-odd"><td><p>upperThresholdWarn</p></td>
<td><p>Numeric</p></td>
<td><p>Optional</p></td>
<td><p>For anomaly detection, a numeric threshold that, when the delta of observed and predicted data exceeds the threshold, a <code class="docutils literal notranslate"><span class="pre">warn</span></code> anomaly is emitted.</p></td>
<td><p>null</p></td>
<td><p>15</p></td>
</tr>
<tr class="row-even"><td><p>upperIsScalar</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>When true, the upper bad and warn thresholds are considered as absolute values above the prediction. When false, the thresholds are considered percentages.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>lowerThresholdBad</p></td>
<td><p>Numeric</p></td>
<td><p>Optional</p></td>
<td><p>For anomaly detection, a numeric threshold that, when the delta of observed and predicted data is lower than the threshold, a <code class="docutils literal notranslate"><span class="pre">bad</span></code> anomaly is emitted.</p></td>
<td><p>null</p></td>
<td><p>25</p></td>
</tr>
<tr class="row-even"><td><p>lowerThresholdWarn</p></td>
<td><p>Numeric</p></td>
<td><p>Optional</p></td>
<td><p>For anomaly detection, a numeric threshold that, when the delta of observed and predicted data is lower than the threshold, a <code class="docutils literal notranslate"><span class="pre">warn</span></code> anomaly is emitted.</p></td>
<td><p>null</p></td>
<td><p>15</p></td>
</tr>
<tr class="row-odd"><td><p>lowerIsScalar</p></td>
<td><p>Boolean</p></td>
<td><p>Optional</p></td>
<td><p>When true, the lower bad and warn thresholds are considered as absolute values below the prediction. When false, the thresholds are considered percentages.</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="output">
<h2>Output</h2>
<p>The output of an anomaly plugin will often consist of multiple time series even if only one is fed into the node. By default the prediction is serialized and the metric name is modified with a suffix of <code class="docutils literal notranslate"><span class="pre">.prediction</span></code> and a tag is added with the key <code class="docutils literal notranslate"><span class="pre">_anomalyModel</span></code> and a value of the model used, e.g. <code class="docutils literal notranslate"><span class="pre">Prophet</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">serializeAlerts</span></code> is enabled, and <code class="docutils literal notranslate"><span class="pre">AlertType</span></code> is emitted in the same result set as the prediction. This a list of time stamps where the observed data exceeded the configured thresholds against the prediction. For example:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;1611860520&quot;</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">&quot;level&quot;</span><span class="o">:</span> <span class="s2">&quot;BAD&quot;</span><span class="p">,</span>
  <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;** TEMP 1.8054497E7 is greater than 1.7681267183127187E7 which is &gt; than 15.0%&quot;</span><span class="p">,</span>
  <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="mf">1.8054497E7</span><span class="p">,</span>
  <span class="s2">&quot;threshold&quot;</span><span class="o">:</span> <span class="mf">1.7681267183127187E7</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;upperBad&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Field definitions:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 14%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>level</p></td>
<td><p>String</p></td>
<td><p>The threshold level, either <code class="docutils literal notranslate"><span class="pre">BAD</span></code> or <code class="docutils literal notranslate"><span class="pre">WARN</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>message</p></td>
<td><p>String</p></td>
<td><p>A message that can be sent to the end user. Note that right now it’s prefixed by <code class="docutils literal notranslate"><span class="pre">**</span> <span class="pre">TEMP</span></code>. We’ll find a way to template that eventually.</p></td>
</tr>
<tr class="row-even"><td><p>value</p></td>
<td><p>Numeric</p></td>
<td><p>The observed value</p></td>
</tr>
<tr class="row-odd"><td><p>threshold</p></td>
<td><p>Numeric</p></td>
<td><p>The computed threshold based off the prediction.</p></td>
</tr>
<tr class="row-even"><td><p>type</p></td>
<td><p>String</p></td>
<td><p>The thresold exceeded. If a <code class="docutils literal notranslate"><span class="pre">bad</span></code> threshold is exceeded, the <code class="docutils literal notranslate"><span class="pre">warn</span></code> is skipped.</p></td>
</tr>
</tbody>
</table>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2021, OpenTSDB.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>